#!/bin/bash

# VÃ©rifier les droits root
if [ "$EUID" -ne 0 ]; then 
    echo "âŒ ExÃ©cutez avec sudo : sudo $0"
    exit 1
fi

# Couleurs
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m'

echo ""
echo " _____ _ _       _ _                   "
echo "|  ___(_) | __ _| | | ___ _ __ ___    "
echo "| |_  | | |/ _\` | | |/ _ \ '__/ __|  "
echo "|  _| | | | (_| | | |  __/ |  \__ \  "
echo "|_|   |_|_|\__,_|_|_|\___|_|  |___/ "
echo ""
echo "=== Installation de Firewall Manager ==="
echo ""

# Demander l'adresse email de l'administrateur
read -p "ğŸ“§ Email administrateur : " ADMIN_EMAIL

# Demander la clÃ© API Mistral
read -p "ğŸ”‘ ClÃ© API Mistral : " MISTRAL_API_KEY

# Installation des dÃ©pendances
echo ""
echo "ğŸ“¦ Installation des dÃ©pendances..."
apt-get update
apt-get install -y python3 python3-pip python3-venv ufw git

# CrÃ©ation du rÃ©pertoire
mkdir -p /opt/firewall-manager
cd /opt/firewall-manager

# Clonage du dÃ©pÃ´t
echo ""
echo "â¬‡ï¸  TÃ©lÃ©chargement de l'application..."
git clone https://github.com/votre-utilisateur/firewall-manager.git .

# Configuration de l'environnement
echo ""
echo "ğŸ”§ Configuration..."
python3 -m venv venv
source venv/bin/activate
pip install --upgrade pip
pip install -r requirements.txt

# CrÃ©ation du fichier de configuration
cat > .env <<EOL
SECRET_KEY=$(openssl rand -hex 32)
HOST=0.0.0.0
PORT=8000
DATABASE_URL=sqlite:////opt/firewall-manager/firewall.db
MISTRAL_API_KEY=${MISTRAL_API_KEY}
ADMIN_EMAIL=${ADMIN_EMAIL}
EOL

# Configuration du service
cat > /etc/systemd/system/firewall-manager.service <<EOL
[Unit]
Description=Firewall Manager
After=network.target

[Service]
User=root
WorkingDirectory=/opt/firewall-manager
Environment="PATH=/opt/firewall-manager/venv/bin"
ExecStart=/opt/firewall-manager/venv/bin/uvicorn app:app --host 0.0.0.0 --port 8000
Restart=always

[Install]
WantedBy=multi-user.target
EOL

# DÃ©marrer le service
echo ""
echo "ğŸš€ DÃ©marrage du service..."
systemctl daemon-reload
systemctl enable firewall-manager
systemctl start firewall-manager

# Configuration du pare-feu
echo ""
echo "ğŸ”¥ Configuration du pare-feu..."
ufw allow 8000/tcp
ufw allow 22/tcp
echo "y" | ufw enable > /dev/null 2>&1

# Afficher les informations d'accÃ¨s
IP=$(hostname -I | awk '{print $1}')

echo ""
echo ""
echo "${GREEN}âœ… Installation terminÃ©e avec succÃ¨s !${NC}"
echo ""
echo "========================================"
echo "  ğŸŒ URL d'accÃ¨s : http://${IP}:8000"
echo "  ğŸ“§ Email admin : ${ADMIN_EMAIL}"
echo "  ğŸ”‘ Mot de passe : admin"
echo ""
echo "${YELLOW}âš ï¸  IMPORTANT : Changez le mot de passe aprÃ¨s la premiÃ¨re connexion${NC}"
echo ""
echo "ğŸ”§ Commandes utiles :"
echo "   systemctl start|stop|restart firewall-manager"
echo "   journalctl -u firewall-manager -f"
echo "========================================"

exit 0
